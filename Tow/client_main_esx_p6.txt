function CarryObjectsMainMenu()
	local elements = {}
	for k, v in pairs(Config.PropEmotes) do
		table.insert(elements, {label = v.label, prop = v.model, bone = v.bone, pos = v.pos, rot = v.rot})
	end
	table.insert(elements, {label = 'Remove Obj', value = 'remove_obj'})
	Menu.Open('default', GetCurrentResourceName(), 'towtrucker_prop_emotes_menu',
		{
			title = 'Prop Emotes',
			align = 'center',
			elements = elements
		},
	function(data, menu)
		if not IsPedInAnyVehicle(GetPlayerPed(-1), true) then 
			if data.current.value == 'remove_obj' then
				menu.close()
				local coords = GetEntityCoords(GetPlayerPed(-1))
				ClearPedTasks(PlayerPedId())
				ClearPedSecondaryTask(PlayerPedId())
				Wait(250)
				DetachEntity(carryModel)
				local allObjects = {"prop_roadcone02a", "prop_tool_box_04", "prop_consign_02a", "prop_mp_barrier_02b"}
				for i = 1, #allObjects, 1 do
					local object = GetClosestObjectOfType(coords, 1.0, GetHashKey(allObjects[i]), false, false, false)
					if object ~= 0 then 
						SetEntityAsMissionEntity(object)
						TriggerServerEvent('t1ger_towtrucker:forceDelete', ObjToNet(object))
						break
					end
				end
				holdingObj = false
				CarryObjectsMainMenu()
			else
				menu.close()
				local coords = GetEntityCoords(GetPlayerPed(-1))
				local selct = data.current
				carryModel = 0
				holdingObj = true
				if selct.prop == "prop_consign_02a" or selct.prop == "prop_mp_barrier_02b" then PlayPushObjAnim() end
				Game.SpawnObject(selct.prop, {x = coords.x, y = coords.y, z = coords.z}, function(spawnModel)
					carryModel = spawnModel
					local boneIndex = GetPedBoneIndex(PlayerPedId(), selct.bone)
					local pX, pY, pZ, rX, rY, rZ = round(selct.pos[1], 2), round(selct.pos[2], 2), round(selct.pos[3], 2), round(selct.rot[1], 2), round(selct.rot[2], 2), round(selct.rot[3], 2)
					AttachEntityToEntity(carryModel, PlayerPedId(), boneIndex, pX, pY, pZ, rX, rY, rZ, true, true, false, true, 2, 1)
				end)
			end
		else
			TriggerEvent('t1ger_towtrucker:notify', Lang['action_not_possible'])
		end
	end, function(data, menu)
		menu.close()
		OpenTowTruckerActionMenu()
	end)
end

CreateThread(function()
	while true do 
		Wait(4)
		if IsControlJustPressed(0, Config.KeyControls['push_pickup_objs']) and carryModel ~= 0 then
			if not IsPedInAnyVehicle(player, true) then
				if Config.TowServices[towID] ~= nil then
					if T1GER_isJob(Config.Society[Config.TowServices[towID].society].name) then 
						local placedObjs = {"prop_roadcone02a", "prop_tool_box_04", "prop_consign_02a", "prop_mp_barrier_02b"}
						local coords, nearDist = GetEntityCoords(GetPlayerPed(-1)), -1
						carryModel = nil
						local objName, zk = nil, Config.PropEmotes
						for i = 1, #placedObjs, 1 do
							local object = GetClosestObjectOfType(coords, 1.5, GetHashKey(placedObjs[i]), false, false, false)
							if DoesEntityExist(object) then
								local objCoords = GetEntityCoords(object)
								local objDist = GetDistanceBetweenCoords(coords, objCoords, true)
								if nearDist == -1 or nearDist > objDist then nearDist = objDist; carryModel = object; objName = placedObjs[i] end
							end
						end
						if holdingObj then 
							holdingObj = false
							if (objName == 'prop_roadcone02a') or (objName == 'prop_tool_box_04') then PlayPickUpAnim() end
							Wait(250)
							DetachEntity(carryModel)
							ClearPedTasks(PlayerPedId())
							ClearPedSecondaryTask(PlayerPedId())
							PlaceObjectOnGroundProperly(carryModel)
						else
							local Dist = GetDistanceBetweenCoords(GetEntityCoords(carryModel), GetEntityCoords(PlayerPedId()), true)
							if Dist < 1.75 then
								holdingObj = true
								if (objName == 'prop_roadcone02a') or (objName == 'prop_tool_box_04') then PlayPickUpAnim() end
								Wait(250)
								ClearPedTasks(PlayerPedId())
								ClearPedSecondaryTask(PlayerPedId())
								if (objName == 'prop_consign_02a') or (objName == 'prop_mp_barrier_02b') then 
									PlayPushObjAnim()
								end
								Wait(250)
								AttachEntityToEntity(carryModel, PlayerPedId(), GetPedBoneIndex(PlayerPedId(), zk[objName].bone), zk[objName].pos[1], zk[objName].pos[2], zk[objName].pos[3], zk[objName].rot[1], zk[objName].rot[2], zk[objName].rot[3], true, true, false, true, 2, 1)
							end
						end
					end
				end
			end
		end
		if holdingObj then
			DisableControlAction(0, 23, true)
		end
	end
end)

function PlayPushObjAnim()
	T1GER_LoadAnim("anim@heists@box_carry@")
	TaskPlayAnim((PlayerPedId()), "anim@heists@box_carry@", "idle", 4.0, 1.0, -1, 49, 0, 0, 0, 0)
end

function PlayPickUpAnim()
	T1GER_LoadAnim("random@domestic")
	TaskPlayAnim(PlayerPedId(), "random@domestic", "pickup_low", 5.0, 1.0, 1.0, 48, 0.0, 0, 0, 0)
end

RegisterNetEvent('t1ger_towtrucker:forceDeleteCL')
AddEventHandler('t1ger_towtrucker:forceDeleteCL', function(objNet)
	if NetworkHasControlOfNetworkId(objNet) then
		DeleteObject(NetToObj(objNet))
	end
end)

local towJob = {}

function TowTruckerJobs()
	local elements = {
		{ label = 'Find Call', value = 'find_job' },
		{ label = 'Cancel Job', value = 'cancel_job' },
	}
	Menu.Open('default', GetCurrentResourceName(), 'towtrucker_npc_job_menu',
		{
			title = 'NPC Job Menu',
			align = 'center',
			elements = elements
		},
	function(data, menu)
		if data.current.value == 'find_job' then
			if towJob.started ~= nil and towJob.started == true then
				return TriggerEvent('t1ger_towtrucker:notify', Lang['job_already_inUse'])
			end
			menu.close()
			math.randomseed(GetGameTimer())
			local type = Config.JobTypes[math.random(#Config.JobTypes)]
			local num = math.random(1, #Config.TowTruckerJobs[type])
			local distance_check = CheckDistance(type, num)
			local count = 0
			while not distance_check and count < 100 do
				count = count + 1
				num = math.random(1, #Config.TowTruckerJobs[type])
				while Config.TowTruckerJobs[type][num].inUse and count < 100 do
					count = count + 1
					num = math.random(1, #Config.TowTruckerJobs[type])
				end
				distance_check = CheckDistance(type, num)
			end
			if count == 100 then
				TriggerEvent('t1ger_towtrucker:notify', Lang['job_no_calls_available'])
			else
				Config.TowTruckerJobs[type][num].inUse = true
				towJob.started = true
				Wait(200)
				TriggerServerEvent('t1ger_towtrucker:JobDataSV', type, num, Config.TowTruckerJobs[type][num])
				TriggerEvent('t1ger_towtrucker:startJobWithNPC', type, num)
			end
		end
		if data.current.value == 'cancel_job' then
			menu.close()
			CancelCurrentJob()
		end
	end, function(data, menu)
		menu.close()
		OpenTowTruckerActionMenu()
	end)
end

function CheckDistance(type, num)
	local check_pos = Config.TowTruckerJobs[type][num].pos
	local travel_dist = CalculateTravelDistanceBetweenPoints(coords.x, coords.y, coords.z, check_pos[1], check_pos[2], check_pos[3])
	if travel_dist < Config.TowTruckerJobs.TravelDistance then
		return true
	else
		return false
	end
end

function CreateJobBlip(pos)
	local blip = AddBlipForCoord(pos[1], pos[2], pos[3])
	SetBlipSprite(blip, 1)
	SetBlipColour(blip, 5)
	AddTextEntry('MYBLIP', 'Tow Trucker Job')
	BeginTextCommandSetBlipName('MYBLIP')
	AddTextComponentSubstringPlayerName(name)
	EndTextCommandSetBlipName(blip)
	SetBlipScale(blip, 0.7)
	SetBlipAsShortRange(blip, true)
	SetBlipRoute(blip, true)
	SetBlipRouteColour(blip, 5)
	return blip
end

function CancelCurrentJob()
	CancelJob = true
	if towJob.veh ~= nil or towJob.ped ~= nil then 
		ClearPedTasksImmediately(towJob.ped)
		FreezeEntityPosition(towJob.ped, false)
		TriggerEvent('t1ger_towtrucker:notify', Lang['job_cancel_by_ply'])
	end
end

AddEventHandler('esx:onPlayerDeath', function()
	CancelCurrentJob()
end)
